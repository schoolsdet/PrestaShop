# This workflow aim to create nightly builds on active branches
name: Nightly Build

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  nightly-build:
    name: Nightly Build

    runs-on: ubuntu-latest

    env:
      PHP_VERSION: '7.4'
      NODE_VERSION: '16'
      RELEASE_DIR: '/tmp/ps-release'
      GH_BRANCH: 'develop'

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ env.GH_BRANCH }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, gd, xml, dom, json, fileinfo, curl, zip, iconv

      - name: Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup NPM
        run: npm install -g npm@7

      - name: Create Release directory
        run: mkdir -p ${{ env.RELEASE_DIR }}

      - name: Create build
        run: php tools/build/CreateRelease.php --destination-dir=${{ env.RELEASE_DIR }}

      - name: Rename build
        run: mv ./*.zip ./${{ github.event.release.tag_name }}.zip
        working-directory: ${{ env.RELEASE_DIR }}

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.RELEASE_DIR }}/${{ github.event.release.tag_name }}.zip
